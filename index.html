<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNY Red Horse (China Speed V4.1)</title>
    <style>
        body { margin: 0; overflow: hidden; background: radial-gradient(circle at center, #2a0000 0%, #000000 100%); font-family: "Microsoft YaHei", sans-serif; }
        #canvas-container { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 1; }
        
        #ui-layer {
            position: absolute; top: 20px; left: 20px; z-index: 10;
            color: #ffd700; pointer-events: none; user-select: none;
            text-shadow: 0 2px 4px rgba(0,0,0,0.9);
        }
        h1 { margin: 0; font-weight: bold; letter-spacing: 3px; font-size: 28px; color: #ff3333; text-shadow: 0 0 15px rgba(255, 0, 0, 0.8); }
        
        .version-tag { font-size: 10px; color: #00ff00; margin-bottom: 10px; border: 1px solid #00ff00; display: inline-block; padding: 2px 5px; background: rgba(0,0,0,0.7);}
        
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #1a0000; z-index: 100; display: flex;
            justify-content: center; align-items: center; color: #ff3333;
            flex-direction: column; transition: opacity 0.5s;
        }
        #start-btn {
            padding: 12px 40px; border: 2px solid #ffd700; background: rgba(255, 0, 0, 0.2);
            color: #ffd700; font-size: 18px; cursor: pointer; letter-spacing: 2px; font-weight: bold;
            transition: 0.3s; margin-top: 20px; display: none; border-radius: 50px;
        }
        #start-btn:hover { background: #ffd700; color: #aa0000; box-shadow: 0 0 25px #ff0000; }
        
        /* å¼ºåˆ¶è·³è¿‡æŒ‰é’® */
        #skip-btn {
            margin-top: 15px; font-size: 12px; color: #999; text-decoration: underline; cursor: pointer; display: none;
        }

        #loading-text { margin-top: 10px; color: #aa5555; font-size: 14px; }
        
        #upload-btn {
            pointer-events: auto; background: rgba(100, 0, 0, 0.6);
            border: 1px solid #ffd700; color: #ffd700; padding: 8px 15px;
            cursor: pointer; margin-top: 15px; display: inline-block;
            font-size: 12px; border-radius: 4px; text-transform: uppercase;
        }
        input[type="file"] { display: none; }
        .input_video { display: none; }
        
        #console-log { position: fixed; bottom: 0; left: 0; width: 100%; height: 100px; background: rgba(0,0,0,0.8); color: #ff5555; font-size: 10px; pointer-events: none; z-index: 999; overflow: auto; display: none; }
    </style>
</head>
<body>
    <div id="console-log"></div>
    <div id="loader">
        <div id="loading-text">æ­£åœ¨ä»å›½å†…æé€ŸæºåŠ è½½...</div>
        <button id="start-btn">å¼€å¯æ–°å¹´ (START)</button>
        <div id="skip-btn">å¤ªæ…¢äº†ï¼Ÿç‚¹æ­¤å¼ºåˆ¶è¿›å…¥ (Force Enter)</div>
    </div>

    <div id="ui-layer">
        <h1>é¾™é©¬ç²¾ç¥ Â· æ–°å¹´å¿«ä¹</h1>
        <div class="version-tag">Ver 4.1 (China Speed)</div>
        <div class="status" id="gesture-status">ç­‰å¾…å¯åŠ¨...</div>
        <div style="margin-top:10px; font-size:14px; color:#ffaaaa; line-height: 1.6;">
            âœŒï¸ <b>å‰ªåˆ€æ‰‹: å¥”è·‘ (Run)</b><br>
            ğŸ– å¼ å¼€æ‰‹: æ¼«æ¸¸ (Scatter)<br>
            âœŠ æ¡æ‹³: èšåˆ (Reset)<br>
            ğŸ‘Œ æåˆ: æŠ“å– (Grab)
        </div>
        <label id="upload-btn">
            ä¸Šä¼ ç…§ç‰‡ (Upload Photos)
            <input type="file" id="file-input" multiple accept="image/*">
        </label>
    </div>

    <video class="input_video" playsinline></video>
    <div id="canvas-container"></div>

    <script src="https://npm.elemecdn.com/three@0.128.0/build/three.min.js"></script>
    <script src="https://npm.elemecdn.com/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://npm.elemecdn.com/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://npm.elemecdn.com/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://npm.elemecdn.com/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
    <script src="https://npm.elemecdn.com/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
    <script src="https://npm.elemecdn.com/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>
    
    <script src="https://npm.elemecdn.com/@mediapipe/camera_utils@0.3.1632432244/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://npm.elemecdn.com/@mediapipe/control_utils@0.6.1629159505/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://npm.elemecdn.com/@mediapipe/drawing_utils@0.3.1620248257/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://npm.elemecdn.com/@mediapipe/hands@0.4.1675469240/hands.js" crossorigin="anonymous"></script>

    <script>
        function log(msg) { const el = document.getElementById('console-log'); el.style.display='block'; el.innerHTML+=`> ${msg}<br>`; console.log(msg); }
        
        window.onload = function() {
            const startBtn = document.getElementById('start-btn'); 
            const loadingText = document.getElementById('loading-text');
            const skipBtn = document.getElementById('skip-btn');

            // 3ç§’åå¦‚æœè¿˜æ²¡åŠ è½½å®Œï¼Œæ˜¾ç¤ºå¼ºåˆ¶è·³è¿‡æŒ‰é’®
            setTimeout(() => {
                if(startBtn.style.display !== 'block') {
                    loadingText.innerText = "èµ„æºåŠ è½½è¾ƒæ…¢...";
                    skipBtn.style.display = 'block';
                }
            }, 3000);

            // å¼ºåˆ¶è·³è¿‡ç‚¹å‡»äº‹ä»¶
            skipBtn.onclick = function() {
                document.getElementById('loader').style.opacity = 0; 
                setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
                initThree();
                // å°è¯•åå°é™é»˜å¯åŠ¨æ‘„åƒå¤´
                startCamera(); 
            };

            if (location.protocol !== 'https:' && location.hostname !== 'localhost') { log("Error: Not HTTPS."); loadingText.innerText="è¯·ä½¿ç”¨ HTTPS"; return; }
            
            // èµ„æºåŠ è½½å®Œæˆ
            loadingText.style.display = 'none'; 
            startBtn.style.display = 'block';
            skipBtn.style.display = 'none'; // æ—¢ç„¶åŠ è½½å®Œäº†å°±éšè—è·³è¿‡

            startBtn.addEventListener('click', () => {
                document.getElementById('loader').style.opacity = 0; 
                setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
                initThree(); 
                startCamera(); 
            });
        };

        const CONFIG = { particleCount: 2200, cameraZ: 70, colors: { red: 0xdd0000, gold: 0xffd700, darkRed: 0x550000 }};
        const STATE = { mode: 'HORSE', handVisible: false, handX: 0.5, handY: 0.5, gesture: 'NONE', runSpeed: 0 };
        let scene, camera, renderer, composer, particlesMesh, photoGroup, dummy = new THREE.Object3D();
        let raycaster = new THREE.Raycaster();
        const centerVector = new THREE.Vector2(0, 0); 
        const particlesData = [], photosData = [];
        let currentLookAt = new THREE.Vector3(0, 5, 0);
        let runTime = 0; 

        function initThree() {
            try {
                const container = document.getElementById('canvas-container');
                scene = new THREE.Scene();
                scene.fog = new THREE.FogExp2(0x1a0000, 0.0015); 

                camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 2000); 
                camera.position.set(0, 10, CONFIG.cameraZ);
                camera.lookAt(0, 5, 0);

                renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                renderer.toneMapping = THREE.ACESFilmicToneMapping;
                renderer.toneMappingExposure = 1.3; 
                container.appendChild(renderer.domElement);

                scene.add(new THREE.AmbientLight(0xffffff, 0.2));
                const l1 = new THREE.PointLight(CONFIG.colors.gold, 3.0, 150); l1.position.set(20, 30, 30); scene.add(l1);
                const l2 = new THREE.PointLight(CONFIG.colors.red, 2.0, 120); l2.position.set(-20, 10, 15); scene.add(l2);
                const l3 = new THREE.DirectionalLight(0xffaa00, 1.0); l3.position.set(0, 50, -20); scene.add(l3); 

                try {
                    const renderScene = new THREE.RenderPass(scene, camera);
                    const bloomPass = new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.5, 0.85);
                    bloomPass.threshold = 0.6; bloomPass.strength = 1.2; bloomPass.radius = 0.5;
                    composer = new THREE.EffectComposer(renderer);
                    composer.addPass(renderScene);
                    composer.addPass(bloomPass);
                } catch(e) { log("Bloom skipped."); composer = null; }

                createHorseParticles();
                photoGroup = new THREE.Group();
                scene.add(photoGroup);

                document.addEventListener('mousemove', e => {
                    if (!STATE.handVisible && STATE.mode === 'SCATTER') updateCameraFromInput(e.clientX/window.innerWidth, e.clientY/window.innerHeight);
                });
                document.addEventListener('click', e => {
                    if(['upload-btn', 'file-input', 'start-btn', 'skip-btn'].includes(e.target.id)) return;
                    if(!STATE.handVisible && photosData.length > 0) { STATE.mode = STATE.mode === 'HORSE' ? 'SCATTER' : 'HORSE'; }
                });

                window.addEventListener('resize', () => {
                    camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                    if(composer) composer.setSize(window.innerWidth, window.innerHeight);
                });
                document.getElementById('file-input').addEventListener('change', handleImageUpload);
                animate();
            } catch(err) { log("3D Init Error: " + err.message); }
        }

        function createHorseParticles() {
            const geo = new THREE.TetrahedronGeometry(0.5, 0); 
            geo.scale(1, 1.5, 0.5);
            const mat = new THREE.MeshStandardMaterial({ color: 0xff0000, roughness: 0.3, metalness: 0.7 });
            particlesMesh = new THREE.InstancedMesh(geo, mat, CONFIG.particleCount);
            const col = new THREE.Color();
            
            for(let i=0; i<CONFIG.particleCount; i++) {
                let part = 0, x=0, y=0, z=0;
                const r = Math.random();
                if (r < 0.45) { 
                    part = 0; x = (Math.random()-0.5) * 12; y = (Math.random()-0.5) * 8 + 10; z = (Math.random()-0.5) * 8;
                } else if (r < 0.65) {
                    part = 1; const neckProgress = Math.random();
                    x = 6 + neckProgress * 4 + (Math.random()-0.5)*3; y = 12 + neckProgress * 8 + (Math.random()-0.5)*3; z = (Math.random()-0.5) * 3;
                    if(neckProgress > 0.8) { x += 2; z *= 1.5; }
                } else if (r < 0.90) {
                    part = 2; const legIndex = Math.floor(Math.random() * 4); 
                    const legX = (legIndex < 2) ? 4 : -4; const legZ = (legIndex % 2 === 0) ? 2.5 : -2.5; 
                    x = legX + (Math.random()-0.5) * 2.5; y = Math.random() * 10; z = legZ + (Math.random()-0.5) * 2;
                    part = 2 + legIndex * 0.1; 
                } else {
                    part = 3; x = -7 - Math.random() * 4; y = 10 - Math.random() * 6; z = (Math.random()-0.5) * 2;
                }

                if (Math.random() > 0.8) col.setHex(CONFIG.colors.gold); else col.setHex(CONFIG.colors.red);
                particlesMesh.setColorAt(i, col);
                dummy.position.set(x, y, z);
                dummy.rotation.set(Math.random()*Math.PI, Math.random()*Math.PI, Math.random()*Math.PI);
                dummy.scale.setScalar(0.5 + Math.random());
                dummy.updateMatrix();
                particlesMesh.setMatrixAt(i, dummy.matrix);
                
                particlesData.push({ idx: i, part: part, cur: new THREE.Vector3(x, y, z), horsePos: new THREE.Vector3(x, y, z), 
                    scat: new THREE.Vector3((Math.random()-0.5)*120, (Math.random()-0.5)*120, (Math.random()-0.5)*120), 
                    speed: 0.02 + Math.random() * 0.03 });
            }
            scene.add(particlesMesh);
        }

        function handleImageUpload(e) {
            const files = e.target.files; if(!files.length) return;
            Array.from(files).forEach(f => {
                const r = new FileReader();
                r.onload = ev => { const img = new Image(); img.src = ev.target.result; img.onload = () => createPhoto(img); };
                r.readAsDataURL(f);
            });
        }

        function createPhoto(img) {
            const tex = new THREE.Texture(img); tex.needsUpdate=true; tex.generateMipmaps=true; tex.encoding = THREE.sRGBEncoding;
            const aspect = img.width/img.height;
            const mat = new THREE.MeshBasicMaterial({ map: tex, side: THREE.DoubleSide, fog: false, toneMapped: false });
            const mesh = new THREE.Mesh(new THREE.PlaneGeometry(5*aspect, 5), mat);
            const frame = new THREE.Mesh(new THREE.BoxGeometry(5*aspect+0.2, 5.2, 0.1), new THREE.MeshStandardMaterial({color:0xffffff}));
            mesh.position.z = 0.06; frame.add(mesh);
            const ty = Math.random()*20 + 5;
            frame.position.set(0, ty, 20);
            frame.userData = { tree: new THREE.Vector3((Math.random()-0.5)*25, ty, (Math.random()-0.5)*20), scat: new THREE.Vector3((Math.random()-0.5)*90, (Math.random()-0.5)*80, (Math.random()-0.5)*90), cur: frame.position.clone(), focus: false };
            photoGroup.add(frame); photosData.push(frame);
        }

        function animate() {
            requestAnimationFrame(animate);
            const time = Date.now() * 0.001;
            
            let targetState = STATE.mode;
            if (STATE.gesture === 'VICTORY') {
                targetState = 'RUNNING'; STATE.runSpeed = Math.min(STATE.runSpeed + 0.02, 1.0); runTime += 0.2;
            } else {
                STATE.runSpeed = Math.max(STATE.runSpeed - 0.02, 0); 
                if(targetState !== 'SCATTER') targetState = 'HORSE';
                runTime += 0.05;
            }

            for(let i=0; i<CONFIG.particleCount; i++) {
                const d = particlesData[i]; let tgt;
                if (targetState === 'SCATTER') tgt = d.scat;
                else {
                    tgt = d.horsePos.clone();
                    if (d.part >= 2 && d.part < 3) { 
                        const legId = Math.floor((d.part - 2) * 10); 
                        const phase = (legId % 2 === 0) ? 0 : Math.PI; 
                        tgt.x += Math.sin(runTime + phase) * 3 *
