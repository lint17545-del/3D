<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNY Ink Horse (V12.0 Staticfile)</title>
    <style>
        body { margin: 0; overflow: hidden; background: radial-gradient(circle at center, #1a0808 0%, #000000 90%); font-family: "Microsoft YaHei", sans-serif; }
        #canvas-container { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 1; }
        
        #ui-layer {
            position: absolute; top: 20px; left: 20px; z-index: 10;
            color: #d4af37; pointer-events: none; user-select: none;
            text-shadow: 0 2px 5px rgba(0,0,0,0.9);
        }
        h1 { margin: 0; font-weight: bold; letter-spacing: 5px; font-size: 32px; color: #ff3333; text-shadow: 0 0 20px rgba(200, 0, 0, 0.6); }
        .subtitle { font-size: 14px; color: #aaaaaa; letter-spacing: 2px; margin-top: 5px; }
        
        .version-tag { font-size: 10px; color: #ffff00; margin-top: 10px; border: 1px solid #ffff00; display: inline-block; padding: 2px 6px; background: rgba(0,0,0,0.6);}
        
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #050000; z-index: 100; display: flex;
            justify-content: center; align-items: center; color: #d4af37;
            flex-direction: column; transition: opacity 0.5s;
        }
        
        /* å¼ºåˆ¶æŒ‰é’® - é»˜è®¤éšè—ï¼Œç”±å®šæ—¶å™¨å¼ºåˆ¶æ˜¾ç¤º */
        #force-enter-btn {
            margin-top: 30px; padding: 15px 40px; 
            background: #ff3333; color: #fff;
            border: 2px solid #fff; cursor: pointer;
            font-size: 16px; font-weight: bold;
            border-radius: 50px;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.6);
            display: none; /* åˆå§‹éšè— */
            pointer-events: auto;
            z-index: 1001;
        }
        #force-enter-btn:hover { background: #ff0000; transform: scale(1.05); }

        #loading-text { margin-top: 10px; color: #888; font-size: 12px; }

        /* è°ƒè¯•æ—¥å¿—é¢æ¿ */
        #debug-panel {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 120px;
            background: rgba(0,0,0,0.85); color: #00ff00; font-family: monospace;
            font-size: 11px; padding: 10px; overflow-y: auto; z-index: 2000;
            border-top: 1px solid #333; pointer-events: none;
        }
        .log-error { color: #ff3333; }
        .log-warn { color: #ffff00; }
        
        #upload-btn {
            pointer-events: auto; background: rgba(50, 0, 0, 0.6);
            border: 1px solid #999; color: #ccc; padding: 6px 12px;
            cursor: pointer; margin-top: 15px; display: inline-block;
            font-size: 12px; border-radius: 2px;
        }
        input[type="file"] { display: none; }
        .input_video { display: none; }
    </style>
</head>
<body>
    <div id="loader">
        <div style="font-size: 24px; letter-spacing: 3px; color: #ff3333;">é¾™é©¬ç²¾ç¥</div>
        <div id="loading-text">æ­£åœ¨è¿æ¥ Staticfile å›½å†…æº...</div>
        <button id="force-enter-btn">å¼ºåˆ¶å”¤é†’ (FORCE START)</button>
    </div>

    <div id="debug-panel"></div>

    <div id="ui-layer">
        <h1>ä¸‡é©¬å¥”è…¾</h1>
        <div class="subtitle">INK PARTICLE V12.0</div>
        <div class="version-tag">Staticfile Source</div>
        <div class="status" id="gesture-status">ç­‰å¾…æŒ‡ä»¤...</div>
        <div style="margin-top:15px; font-size:12px; color:#888; line-height: 1.8;">
            äº¤äº’æŒ‡å—ï¼š<br>
            âœŒï¸ å‰ªåˆ€æ‰‹ï¼šå…¨é€Ÿå¥”è·‘ (Gallop)<br>
            ğŸ– å¼ å¼€æ‰‹ï¼šç²’å­æ•£å¼€ (Disperse)<br>
            ğŸ–±ï¸ é¼ æ ‡ï¼šå¸é™„äº¤äº’
        </div>
        <label id="upload-btn">
            ä¸Šä¼ ç…§ç‰‡
            <input type="file" id="file-input" multiple accept="image/*">
        </label>
    </div>

    <video class="input_video" playsinline></video>
    <div id="canvas-container"></div>

    <script>
        // æ—¥å¿—ç³»ç»Ÿ
        function log(msg, type='info') {
            const panel = document.getElementById('debug-panel');
            const line = document.createElement('div');
            line.textContent = `> ${msg}`;
            if(type==='error') line.className = 'log-error';
            if(type==='warn') line.className = 'log-warn';
            panel.appendChild(line);
            panel.scrollTop = panel.scrollHeight;
            console.log(msg);
        }

        // 3ç§’åå¼ºåˆ¶æ˜¾ç¤ºæŒ‰é’®ï¼Œä¸ç®¡è„šæœ¬æœ‰æ²¡æœ‰åŠ è½½å®Œ
        setTimeout(() => {
            const btn = document.getElementById('force-enter-btn');
            if(btn.style.display !== 'block') {
                btn.style.display = 'block';
                log("Wait timeout: Force button shown.", 'warn');
                document.getElementById('loading-text').innerText = "åŠ è½½è¾ƒæ…¢ï¼Œè¯·ç‚¹å‡»å¼ºåˆ¶å”¤é†’";
            }
        }, 3000);

        // æŒ‰é’®ç‚¹å‡»é€»è¾‘
        document.getElementById('force-enter-btn').onclick = function() {
            log("User clicked Force Start.");
            
            if(typeof THREE === 'undefined') {
                alert("ä¸¥é‡é”™è¯¯ï¼šThree.js æ ¸å¿ƒåº“æœªåŠ è½½æˆåŠŸã€‚\nè¯·æ£€æŸ¥ç½‘ç»œæˆ–åˆ·æ–°é¡µé¢ã€‚");
                log("FATAL: THREE missing.", 'error');
                return;
            }

            document.getElementById('loader').style.opacity = 0;
            setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
            
            try {
                init();
                log("3D Init Success.");
            } catch(e) {
                log("3D Init Failed: " + e.message, 'error');
                alert("å¯åŠ¨é”™è¯¯: " + e.message);
            }

            try { startAI(); } catch(e) { log("AI Start Skipped: " + e.message, 'warn'); }
        };
    </script>

    <script src="https://cdn.staticfile.org/three.js/r128/three.min.js" onload="log('Three.js loaded')" onerror="log('Three.js FAILED', 'error')"></script>
    <script src="https://cdn.staticfile.org/three.js/r128/examples/js/postprocessing/EffectComposer.js" onload="log('Composer loaded')" onerror="log('Composer FAILED', 'warn')"></script>
    <script src="https://cdn.staticfile.org/three.js/r128/examples/js/postprocessing/RenderPass.js" onload="log('RenderPass loaded')" onerror="log('RenderPass FAILED', 'warn')"></script>
    <script src="https://cdn.staticfile.org/three.js/r128/examples/js/postprocessing/ShaderPass.js" onload="log('ShaderPass loaded')" onerror="log('ShaderPass FAILED', 'warn')"></script>
    <script src="https://cdn.staticfile.org/three.js/r128/examples/js/shaders/CopyShader.js" onload="log('CopyShader loaded')" onerror="log('CopyShader FAILED', 'warn')"></script>
    <script src="https://cdn.staticfile.org/three.js/r128/examples/js/shaders/LuminosityHighPassShader.js" onload="log('Luminosity loaded')" onerror="log('Luminosity FAILED', 'warn')"></script>
    <script src="https://cdn.staticfile.org/three.js/r128/examples/js/postprocessing/UnrealBloomPass.js" onload="log('BloomPass loaded')" onerror="log('BloomPass FAILED', 'warn')"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" onload="log('MP Camera loaded')" onerror="log('MP Camera FAILED', 'warn')"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" onload="log('MP Control loaded')" onerror="log('MP Control FAILED', 'warn')"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" onload="log('MP Drawing loaded')" onerror="log('MP Drawing FAILED', 'warn')"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" onload="log('MP Hands loaded')" onerror="log('MP Hands FAILED', 'warn')"></script>

    <script type="x-shader/x-vertex" id="vertexshader">
        attribute float size; attribute vec3 customColor; attribute float limbType; 
        uniform float time; uniform float runFactor; uniform float scatter; uniform vec3 mousePos;
        varying vec3 vColor; varying float vAlpha;
        void main() {
            vColor = customColor; vAlpha = 1.0;
            vec3 pos = position;
            float t = time * (1.5 + runFactor * 4.0);
            if (limbType > 0.5 && limbType < 1.5) { 
                pos.x -= sin(t * 1.5 + pos.y*0.2) * (0.5 + runFactor); 
                pos.y += cos(t * 2.0 + pos.x*0.2) * (0.3 + runFactor);
                pos.z += sin(t * 1.0) * 0.5;
            } else if (limbType > 1.5) { 
                float phase = (pos.x > 0.0) ? 0.0 : 3.14;
                float legPower = runFactor * 2.5;
                pos.x += sin(t + phase) * legPower;
                pos.y += max(0.0, cos(t + phase)) * legPower * 0.8;
            } else { 
                pos.y += sin(t * 2.0) * 0.2 * runFactor;
            }
            float d = distance(pos.xy, mousePos.xy * 40.0);
            if (d < 15.0) {
                vec3 dir = normalize(pos - vec3(mousePos.xy * 40.0, 0.0));
                pos += dir * (15.0 - d) * 0.3;
            }
            if (scatter > 0.0) {
                pos.x += sin(pos.y * 10.0 + time) * scatter * 10.0;
                vAlpha = 1.0 - scatter * 0.8;
            }
            vec4 mvPosition = modelViewMatrix * vec4(pos, 1.0);
            gl_PointSize = size * (300.0 / -mvPosition.z);
            gl_Position = projectionMatrix * mvPosition;
        }
    </script>
    <script type="x-shader/x-fragment" id="fragmentshader">
        varying vec3 vColor; varying float vAlpha;
        void main() {
            vec2 cxy = 2.0 * gl_PointCoord - 1.0;
            if (dot(cxy, cxy) > 1.0) discard;
            gl_FragColor = vec4(vColor, vAlpha * 0.8);
        }
    </script>

    <script>
        const CONFIG = { particleSize: 0.8, colors: { red: new THREE.Color(0xdd2222), gold: new THREE.Color(0xffd700), black: new THREE.Color(0x220000) } };
        let scene, camera, renderer, particles, uniforms;
        let mouse = new THREE.Vector2(-999, -999);
        const STATE = { mode: 'HORSE' }; 

        function drawHorseSilhouette() {
            const canvas = document.createElement('canvas');
            const size = 256; canvas.width = size; canvas.height = size;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#000000'; ctx.fillRect(0, 0, size, size);
            ctx.fillStyle = '#ffffff'; ctx.beginPath();
            const ox = 100, oy = 130; const s = 0.6;
            ctx.moveTo(ox + 50*s, oy - 100*s); ctx.lineTo(ox + 80*s, oy - 90*s);
            ctx.quadraticCurveTo(ox + 60*s, oy - 60*s, ox + 40*s, oy - 50*s);
            ctx.quadraticCurveTo(ox + 60*s, oy + 20*s, ox + 80*s, oy + 50*s);
            ctx.lineTo(ox + 70*s, oy + 100*s); ctx.lineTo(ox + 50*s, oy + 60*s);
            ctx.lineTo(ox - 50*s, oy + 40*s); ctx.lineTo(ox - 80*s, oy + 90*s); ctx.lineTo(ox - 100*s, oy + 50*s);
            ctx.quadraticCurveTo(ox - 120*s, oy, ox - 50*s, oy - 40*s);
            ctx.quadraticCurveTo(ox, oy - 60*s, ox + 30*s, oy - 110*s); ctx.fill();
            ctx.fillStyle = '#808080'; ctx.beginPath(); 
            ctx.ellipse(ox + 20*s, oy - 90*s, 30*s, 10*s, -0.5, 0, 6.28); ctx.fill();
            ctx.beginPath(); 
            ctx.moveTo(ox - 110*s, oy); ctx.quadraticCurveTo(ox - 150*s, oy + 50*s, ox - 130*s, oy + 80*s);
            ctx.lineTo(ox - 110*s, oy + 30*s); ctx.fill();
            return { canvas, ctx };
        }

        function init() {
            const container = document.getElementById('canvas-container');
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 60; camera.position.y = 5;
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            container.appendChild(renderer.domElement);
            createParticles();
            document.addEventListener('mousemove', onMouseMove, false);
            window.addEventListener('resize', onResize, false);
            animate();
        }

        function createParticles() {
            const { canvas, ctx } = drawHorseSilhouette();
            const w = canvas.width; const h = canvas.height;
            const data = ctx.getImageData(0, 0, w, h).data;
            const positions=[], colors=[], sizes=[], limbTypes=[];
            for(let y=0; y<h; y+=2) {
                for(let x=0; x<w; x+=2) {
                    const i = (y*w + x)*4; const r = data[i];
                    if(data[i+3] > 20) {
                        const px = (x - w/2) * 0.25; const py = -(y - h/2) * 0.25; const pz = (Math.random()-0.5) * 3.0;
                        positions.push(px, py, pz);
                        const c = new THREE.Color();
                        if (r > 200) c.copy(CONFIG.colors.red).lerp(CONFIG.colors.black, Math.random()*0.5);
                        else c.copy(CONFIG.colors.gold);
                        colors.push(c.r, c.g, c.b);
                        sizes.push(CONFIG.particleSize * (0.8 + Math.random()));
                        let type = 0.0; if (r > 100 && r < 200) type = 1.0; if (py < -5) type = 2.0; 
                        limbTypes.push(type);
                    }
                }
            }
            const geo = new THREE.BufferGeometry();
            geo.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geo.setAttribute('customColor', new THREE.Float32BufferAttribute(colors, 3));
            geo.setAttribute('size', new THREE.Float32BufferAttribute(sizes, 1));
            geo.setAttribute('limbType', new THREE.Float32BufferAttribute(limbTypes, 1));
            uniforms = { time: { value: 0.0 }, runFactor: { value: 0.0 }, scatter: { value: 0.0 }, mousePos: { value: new THREE.Vector3(0,0,0) } };
            const mat = new THREE.ShaderMaterial({ uniforms: uniforms, vertexShader: document.getElementById('vertexshader').textContent, fragmentShader: document.getElementById('fragmentshader').textContent, blending: THREE.AdditiveBlending, depthTest: false, transparent: true });
            particles = new THREE.Points(geo, mat);
            scene.add(particles);
            particles.position.x = -5;
        }

        function onMouseMove(e) { e.preventDefault(); mouse.x = (e.clientX / window.innerWidth) * 2 - 1; mouse.y = -(e.clientY / window.innerHeight) * 2 + 1; if(uniforms) uniforms.mousePos.value.set(mouse.x, mouse.y, 0); }
        function onResize() { camera.aspect = window.innerWidth / window.innerHeight;
