<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNY Red Horse (2026 Special)</title>
    <style>
        /* èƒŒæ™¯æ”¹ä¸ºæ·±çº¢æ¸å˜ï¼Œçƒ˜æ‰˜è¿‡å¹´æ°”æ°› */
        body { margin: 0; overflow: hidden; background: radial-gradient(circle at center, #2a0000 0%, #000000 100%); font-family: sans-serif; }
        #canvas-container { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 1; }
        
        #ui-layer {
            position: absolute; top: 20px; left: 20px; z-index: 10;
            color: #ffd700; /* é‡‘è‰²å­—ä½“ */
            pointer-events: none; user-select: none;
            text-shadow: 0 2px 4px rgba(0,0,0,0.9);
        }
        h1 { margin: 0; font-weight: bold; letter-spacing: 3px; font-size: 28px; color: #ff3333; text-shadow: 0 0 15px rgba(255, 0, 0, 0.8); }
        
        .version-tag { font-size: 10px; color: #ffd700; margin-bottom: 10px; border: 1px solid #ffd700; display: inline-block; padding: 2px 5px; background: rgba(0,0,0,0.7);}
        
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #1a0000; z-index: 100; display: flex;
            justify-content: center; align-items: center; color: #ff3333;
            flex-direction: column; transition: opacity 0.5s;
        }
        #start-btn {
            padding: 12px 40px; border: 2px solid #ffd700; background: rgba(255, 0, 0, 0.2);
            color: #ffd700; font-size: 18px; cursor: pointer; letter-spacing: 2px; font-weight: bold;
            transition: 0.3s; margin-top: 20px; display: none; border-radius: 50px;
        }
        #start-btn:hover { background: #ffd700; color: #aa0000; box-shadow: 0 0 25px #ff0000; }
        #loading-text { margin-top: 10px; color: #aa5555; font-size: 14px; }
        
        #upload-btn {
            pointer-events: auto; background: rgba(100, 0, 0, 0.6);
            border: 1px solid #ffd700; color: #ffd700; padding: 8px 15px;
            cursor: pointer; margin-top: 15px; display: inline-block;
            font-size: 12px; border-radius: 4px; text-transform: uppercase;
        }
        input[type="file"] { display: none; }
        .input_video { display: none; }
        
        #console-log { position: fixed; bottom: 0; left: 0; width: 100%; height: 100px; background: rgba(0,0,0,0.8); color: #ff5555; font-size: 10px; pointer-events: none; z-index: 999; overflow: auto; display: none; }
    </style>
</head>
<body>
    <div id="console-log"></div>
    <div id="loader">
        <div id="loading-text">æ­£åœ¨å¬å”¤ç¥é©¬ (Loading)...</div>
        <button id="start-btn">å¼€å¯æ–°å¹´ (START)</button>
    </div>

    <div id="ui-layer">
        <h1>é¾™é©¬ç²¾ç¥ Â· æ–°å¹´å¿«ä¹</h1>
        <div class="version-tag">Ver 4.0 (Red Horse Edition)</div>
        <div class="status" id="gesture-status">ç­‰å¾…å¯åŠ¨...</div>
        <div style="margin-top:10px; font-size:14px; color:#ffaaaa; line-height: 1.6;">
            âœŒï¸ <b>å‰ªåˆ€æ‰‹ (V-Sign): å¥”è·‘ (Run)</b><br>
            ğŸ– å¼ å¼€æ‰‹: æ•£å¼€æ¼«æ¸¸ (Scatter)<br>
            âœŠ æ¡æ‹³: èšåˆ (Reset)<br>
            ğŸ‘Œ æåˆ: æŠ“å–ç…§ç‰‡ (Grab Photo)
        </div>
        <label id="upload-btn">
            ä¸Šä¼ ç…§ç‰‡ (Upload Photos)
            <input type="file" id="file-input" multiple accept="image/*">
        </label>
    </div>

    <video class="input_video" playsinline></video>
    <div id="canvas-container"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>
    <script src="https://unpkg.com/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <script>
        function log(msg) { const el = document.getElementById('console-log'); el.style.display='block'; el.innerHTML+=`> ${msg}<br>`; console.log(msg); }
        window.onload = function() {
            const startBtn = document.getElementById('start-btn'); const loadingText = document.getElementById('loading-text');
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') { log("Error: Not HTTPS."); loadingText.innerText="Please use HTTPS"; return; }
            loadingText.style.display = 'none'; startBtn.style.display = 'block';
            startBtn.addEventListener('click', () => {
                document.getElementById('loader').style.opacity = 0; setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
                initThree(); startCamera(); 
            });
        };

        const CONFIG = { 
            particleCount: 2200, // å¢åŠ ç²’å­è®©é©¬æ›´å¯†å®
            cameraZ: 70,
            colors: { 
                red: 0xdd0000,    // æ­£çº¢
                gold: 0xffd700,   // é‡‘è‰²
                darkRed: 0x550000 // æš—çº¢
            }
        };

        const STATE = { 
            mode: 'HORSE', // HORSE, SCATTER, RUNNING
            handVisible: false, handX: 0.5, handY: 0.5, gesture: 'NONE',
            runSpeed: 0
        };

        let scene, camera, renderer, composer, particlesMesh, photoGroup, dummy = new THREE.Object3D();
        let raycaster = new THREE.Raycaster();
        const centerVector = new THREE.Vector2(0, 0); 
        const particlesData = [], photosData = [];
        
        let lookAtTarget = new THREE.Vector3(0, 5, 0);
        let currentLookAt = new THREE.Vector3(0, 5, 0);
        let runTime = 0; // ç”¨äºå¥”è·‘åŠ¨ç”»çš„æ—¶é—´ç´¯ç§¯

        function initThree() {
            try {
                const container = document.getElementById('canvas-container');
                scene = new THREE.Scene();
                // çº¢è‰²ç³»çš„é›¾
                scene.fog = new THREE.FogExp2(0x1a0000, 0.0015); 

                camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 2000); 
                camera.position.set(0, 10, CONFIG.cameraZ);
                camera.lookAt(0, 5, 0);

                renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                renderer.toneMapping = THREE.ACESFilmicToneMapping;
                renderer.toneMappingExposure = 1.3; 
                container.appendChild(renderer.domElement);

                // ç¯å…‰è®¾ç½®ï¼šé‡‘è‰²å…‰+çº¢è‰²å…‰
                scene.add(new THREE.AmbientLight(0xffffff, 0.2));
                const l1 = new THREE.PointLight(CONFIG.colors.gold, 3.0, 150); l1.position.set(20, 30, 30); scene.add(l1);
                const l2 = new THREE.PointLight(CONFIG.colors.red, 2.0, 120); l2.position.set(-20, 10, 15); scene.add(l2);
                const l3 = new THREE.DirectionalLight(0xffaa00, 1.0); l3.position.set(0, 50, -20); scene.add(l3); // é¡¶å…‰

                try {
                    const renderScene = new THREE.RenderPass(scene, camera);
                    // è¾‰å…‰å‚æ•°è°ƒå¼ºï¼Œåˆ¶é€ å–œåº†æ„Ÿ
                    const bloomPass = new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.5, 0.85);
                    bloomPass.threshold = 0.6; bloomPass.strength = 1.2; bloomPass.radius = 0.5;
                    composer = new THREE.EffectComposer(renderer);
                    composer.addPass(renderScene);
                    composer.addPass(bloomPass);
                } catch(e) { log("Bloom skipped."); composer = null; }

                createHorseParticles();
                photoGroup = new THREE.Group();
                scene.add(photoGroup);

                document.addEventListener('mousemove', e => {
                    if (!STATE.handVisible && STATE.mode === 'SCATTER') updateCameraFromInput(e.clientX/window.innerWidth, e.clientY/window.innerHeight);
                });
                document.addEventListener('click', e => {
                    if(['upload-btn', 'file-input', 'start-btn'].includes(e.target.id)) return;
                    if(!STATE.handVisible && photosData.length > 0) { STATE.mode = STATE.mode === 'HORSE' ? 'SCATTER' : 'HORSE'; }
                });

                window.addEventListener('resize', () => {
                    camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                    if(composer) composer.setSize(window.innerWidth, window.innerHeight);
                });
                document.getElementById('file-input').addEventListener('change', handleImageUpload);
                animate();
            } catch(err) { log("3D Init Error: " + err.message); }
        }

        function createHorseParticles() {
            // ã€ä¿®æ”¹ï¼šèŠ±ç“£å½¢çŠ¶ã€‘ä½¿ç”¨å››é¢ä½“ï¼Œæ¨¡æ‹ŸèŠ±ç“£/è±å½¢
            const geo = new THREE.TetrahedronGeometry(0.5, 0); 
            // ç¨å¾®å‹æ‰ä¸€ç‚¹ï¼ŒåƒèŠ±ç“£
            geo.scale(1, 1.5, 0.5);

            const mat = new THREE.MeshStandardMaterial({ color: 0xff0000, roughness: 0.3, metalness: 0.7 });
            particlesMesh = new THREE.InstancedMesh(geo, mat, CONFIG.particleCount);
            
            const col = new THREE.Color();
            
            for(let i=0; i<CONFIG.particleCount; i++) {
                // 1. æ„å»ºé©¬çš„å½¢æ€ (é€šè¿‡æ•°å­¦æ¦‚ç‡åˆ†å¸ƒ)
                // èº«ä½“éƒ¨ä½ ID: 0=Body, 1=Neck/Head, 2=Legs, 3=Tail
                let part = 0; 
                let x=0, y=0, z=0;

                const r = Math.random();
                
                if (r < 0.45) { 
                    // èº¯å¹² (æ¤­åœ†)
                    part = 0;
                    x = (Math.random()-0.5) * 12;
                    y = (Math.random()-0.5) * 8 + 10;
                    z = (Math.random()-0.5) * 8;
                } else if (r < 0.65) {
                    // è„–å­å’Œå¤´
                    part = 1;
                    const neckProgress = Math.random();
                    x = 6 + neckProgress * 4 + (Math.random()-0.5)*3; // å‘å‰ä¼¸
                    y = 12 + neckProgress * 8 + (Math.random()-0.5)*3; // å‘ä¸Šä¼¸
                    z = (Math.random()-0.5) * 3;
                    if(neckProgress > 0.8) { // å¤´éƒ¨ç¨å¾®å¤§ä¸€ç‚¹
                         x += 2; z *= 1.5;
                    }
                } else if (r < 0.90) {
                    // å››æ¡è…¿ (å…³é”®ï¼šè®°å½•å±äºå“ªæ¡è…¿ï¼Œæ–¹ä¾¿åŠ¨ç”»)
                    part = 2;
