<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>SPIC V17 - Independent Core</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Microsoft YaHei', sans-serif; }
        
        /* é”™è¯¯æ§åˆ¶å° (ä»…å‡ºé”™æ—¶æ˜¾ç¤º) */
        #debug-console { 
            position: fixed; top: 0; left: 0; width: 100%; background: rgba(100,0,0,0.8); 
            color: #fff; font-size: 12px; padding: 5px; display: none; z-index: 9999; 
        }

        /* è§†é¢‘åé¦ˆ */
        #video-element { position: absolute; bottom: 20px; left: 20px; width: 120px; opacity: 0.4; border: 1px solid #444; border-radius: 4px; transform: scaleX(-1); z-index: 2; pointer-events: none;}
        
        /* UI å±‚ */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        
        .header { position: absolute; top: 40px; width: 100%; text-align: center; }
        h1 { margin: 0; font-size: 32px; color: #fff; letter-spacing: 8px; text-shadow: 0 0 20px rgba(0,150,255,0.8); font-weight: 100; }
        .sub-title { font-size: 14px; color: #00ffff; letter-spacing: 4px; opacity: 0.7; margin-top: 5px; }

        /* çŠ¶æ€èƒ¶å›Š */
        #status-pill {
            position: absolute; top: 130px; left: 50%; transform: translateX(-50%);
            background: rgba(0,20,30,0.8); border: 1px solid rgba(0,255,255,0.3);
            padding: 8px 30px; border-radius: 50px;
            color: #FFD700; font-size: 15px; letter-spacing: 1px;
            box-shadow: 0 0 30px rgba(0,0,0,0.8); transition: all 0.3s;
        }

        /* æ“ä½œæŒ‡å¼• */
        .guide { position: absolute; bottom: 40px; width: 100%; text-align: center; color: rgba(255,255,255,0.4); font-size: 13px; letter-spacing: 2px; }
        
        /* ä¸Šä¼ æŒ‰é’® */
        #upload-wrap {
            position: absolute; right: 40px; top: 40px; pointer-events: auto;
            background: rgba(0,0,0,0.6); border: 1px solid #00ffff; color: #00ffff;
            padding: 10px 20px; border-radius: 4px; cursor: pointer;
            font-size: 12px; transition: 0.3s;
        }
        #upload-wrap:hover { background: #00ffff; color: #000; box-shadow: 0 0 20px #00ffff; }
        input[type="file"] { display: none; }

        /* å‡†æ˜Ÿ (å…‰æ ‡) */
        #cursor {
            position: fixed; top: 50%; left: 50%; width: 30px; height: 30px;
            border: 2px solid rgba(255,255,255,0.2); border-radius: 50%;
            transform: translate(-50%, -50%); pointer-events: none; transition: 0.2s;
        }
        #cursor.active { border-color: #00ff00; width: 50px; height: 50px; background: rgba(0,255,0,0.1); box-shadow: 0 0 20px #00ff00; }
    </style>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>

    <div id="debug-console"></div>

    <div id="ui-layer">
        <div class="header">
            <h1>SPIC èƒ½æºè§†ç•Œ</h1>
            <div class="sub-title">V17 GENERATIVE ENGINE</div>
        </div>
        <div id="status-pill">ç³»ç»Ÿåˆå§‹åŒ–...</div>
        <div id="cursor"></div>
        <div class="guide">
            âœŠèšåˆ(åˆ‡æ¢) &nbsp;|&nbsp; ğŸ–ç”»å»Š(æ—‹è½¬) &nbsp;|&nbsp; ğŸ‘Œæåˆ(æŠ“å–)
            <br><span style="opacity:0.6; font-size:11px">æ”¯æŒé¼ æ ‡æ“ä½œï¼šç‚¹å‡»=æŠ“å–ï¼Œç§»åŠ¨=æ—‹è½¬</span>
        </div>
        <label id="upload-wrap">
            + æ³¨å…¥ç…§ç‰‡
            <input type="file" id="file-input" multiple accept="image/*">
        </label>
    </div>

    <video id="video-element" playsinline></video>
    <div id="canvas-container"></div>
    <canvas id="genCanvas" width="2048" height="1024" style="display:none;"></canvas>

    <script>
        // å…¨å±€é”™è¯¯æ•è·
        window.onerror = function(msg, url, line) {
            const div = document.getElementById('debug-console');
            div.style.display = 'block';
            div.innerHTML += `ERROR: ${msg} (Line ${line})<br>`;
        };
    </script>

    <script type="module">
        import * as THREE from 'three';
        // æ³¨æ„ï¼šä¸å†å¼•å…¥ GLTFLoaderï¼Œé˜²æ­¢åŠ è½½å¡æ­»
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';

        // --- æˆ˜é©¬éª¨éª¼å…³é”®ç‚¹æ•°æ® (ç¡¬ç¼–ç ï¼Œç¡®ä¿æ— éœ€ä¸‹è½½) ---
        // ç®€åŒ–ç‰ˆçš„é©¬èº¯å¹²ã€å¤´ã€è…¿çš„å…³é”®åæ ‡
        const HORSE_KEY_POINTS = [
            0,20,10, 5,20,8, 10,22,5, 15,25,0, 20,28,-2, 25,20,-2, 28,15,-3, 25,10,-2, 20,5,0, 15,0,2, // å¤´é¢ˆ
            -5,18,12, -10,18,12, -15,18,10, -20,15,8, -25,10,5, // èº¯å¹²ä¸Š
            -5,5,10, -10,5,10, -15,5,8, -20,8,5, // èº¯å¹²ä¸‹
            5,-10,5, 5,-20,5, 5,-30,5, // å‰è…¿
            -20,-10,5, -22,-20,6, -25,-30,8, // åè…¿
            -30,15,5, -35,10,5, -35,5,5 // å°¾å·´
        ];

        // --- é…ç½® ---
        const CONFIG = {
            count: 24000, // ç²’å­æ€»é‡
            colors: {
                horse: [new THREE.Color(0xD4AF37), new THREE.Color(0xC41E3A), new THREE.Color(0xFF4500)], // çº¢é‡‘æˆ˜é©¬
                tower: [new THREE.Color(0x00BFFF), new THREE.Color(0xFFFFFF), new THREE.Color(0x228B22)], // è“å¤©ç™½äº‘ç»¿åœ°
                wind: [new THREE.Color(0x00FF7F), new THREE.Color(0xF0FFFF)], // è§å…‰ç»¿+ç™½
                text: [new THREE.Color(0x88CCFF)] // æ˜Ÿå…‰è“
            }
        };

        // --- å˜é‡ ---
        let scene, camera, renderer, composer;
        let particleSystem, geometry;
        let photoGroup, photos = [];
        let raycaster = new THREE.Raycaster();
        
        // çŠ¶æ€
        const STATE = {
            mode: 'SCATTER', // SCATTER, MORPH, ZOOM
            shapeIdx: 0,     // 0:é©¬, 1:æ–‡å­—, 2:å‡‰æ°´å¡”, 3:é£å…‰
            handX: 0.5,
            isHandActive: false,
            autoRotate: 0
        };

        // ä½ç½®æ•°æ®ç¼“å­˜
        const POSITIONS = { HORSE:[], TEXT:[], TOWER:[], SCENE:[], SCATTER:[] };
        
        // äº¤äº’
        let hoveredPhoto = null;
        let grabbedPhoto = null;

        init();

        function init() {
            try {
                const container = document.getElementById('canvas-container');
                
                // 1. åœºæ™¯
                scene = new THREE.Scene();
                scene.fog = new THREE.FogExp2(0x000000, 0.001);

                camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.1, 5000);
                camera.position.set(0, 0, 420);

                renderer = new THREE
