<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNY Horse (V13.0 V3.4-Network)</title>
    <style>
        body { margin: 0; overflow: hidden; background: radial-gradient(circle at center, #1a0505 0%, #000000 90%); font-family: sans-serif; }
        #canvas-container { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 1; }
        
        #ui-layer {
            position: absolute; top: 20px; left: 20px; z-index: 10;
            color: #d4af37; pointer-events: none; user-select: none;
            text-shadow: 0 2px 5px rgba(0,0,0,0.9);
        }
        h1 { margin: 0; font-weight: bold; letter-spacing: 5px; font-size: 32px; color: #ff3333; text-shadow: 0 0 20px rgba(200, 0, 0, 0.6); }
        .version-tag { font-size: 10px; color: #00ff00; margin-top: 10px; border: 1px solid #00ff00; display: inline-block; padding: 2px 6px; background: rgba(0,0,0,0.6);}
        
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #050000; z-index: 100; display: flex;
            justify-content: center; align-items: center; color: #d4af37;
            flex-direction: column; transition: opacity 0.8s;
        }
        
        #start-btn {
            margin-top: 30px; padding: 15px 50px; 
            background: #d4af37; color: #000;
            border: 2px solid #fff; cursor: pointer;
            font-size: 18px; letter-spacing: 4px; font-weight: bold;
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.4);
            border-radius: 50px; transition: 0.3s;
            display: none; 
        }
        #start-btn:hover { background: #fff; transform: scale(1.05); }

        #debug-log {
            position: fixed; bottom: 10px; left: 10px; 
            font-size: 10px; color: #666; font-family: monospace;
            z-index: 200; pointer-events: none; max-width: 50%;
        }
        
        #upload-btn {
            pointer-events: auto; background: rgba(50, 0, 0, 0.6);
            border: 1px solid #999; color: #ccc; padding: 6px 12px;
            cursor: pointer; margin-top: 15px; display: inline-block;
            font-size: 12px; border-radius: 2px;
        }
        input[type="file"] { display: none; }
        .input_video { display: none; }
    </style>
</head>
<body>
    <div id="loader">
        <div style="font-size: 24px; letter-spacing: 3px; color: #ff3333;">ÈæôÈ©¨Á≤æÁ•û</div>
        <div id="loading-text" style="font-size: 12px; color: #888; margin-top: 10px;">Ê≠£Âú®Âä†ËΩΩ (V3.4 ÈÖçÁΩÆ)...</div>
        <button id="start-btn">ÁÇπÂáªÂî§ÈÜí (AWAKEN)</button>
    </div>

    <div id="debug-log">Init...</div>

    <div id="ui-layer">
        <h1>‰∏áÈ©¨Â•îËÖæ</h1>
        <div class="version-tag">V13.0 (Proven Network)</div>
        <div class="status" id="gesture-status">Á≠âÂæÖÊåá‰ª§...</div>
        <div style="margin-top:15px; font-size:12px; color:#888; line-height: 1.8;">
            ‚úåÔ∏è Ââ™ÂàÄÊâãÔºöÂ•îË∑ë (Gallop)<br>
            üñê Âº†ÂºÄÊâãÔºöÊï£ÂºÄ (Disperse)<br>
            üñ±Ô∏è Èº†Ê†áÔºöÁ≤íÂ≠êÂê∏ÈôÑ
        </div>
        <label id="upload-btn">
            ‰∏ä‰º†ÁÖßÁâá
            <input type="file" id="file-input" multiple accept="image/*">
        </label>
    </div>

    <video class="input_video" playsinline></video>
    <div id="canvas-container"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>
    
    <script src="https://unpkg.com/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <script type="x-shader/x-vertex" id="vertexshader">
        attribute float size; attribute vec3 customColor; attribute float limbType; 
        uniform float time; uniform float runFactor; uniform float scatter; uniform vec3 mousePos;
        varying vec3 vColor; varying float vAlpha;
        void main() {
            vColor = customColor; vAlpha = 1.0;
            vec3 pos = position;
            // Â•îË∑ëÂä®Áîª
            float t = time * (1.5 + runFactor * 4.0);
            if (limbType > 0.5 && limbType < 1.5) { // È¨ÉÊØõ
                pos.x -= sin(t * 1.5 + pos.y*0.2) * (0.5 + runFactor); 
                pos.y += cos(t * 2.0 + pos.x*0.2) * (0.3 + runFactor);
                pos.z += sin(t * 1.0) * 0.5;
            } else if (limbType > 1.5) { // ËÖø
                float phase = (pos.x > 0.0) ? 0.0 : 3.14;
                float legPower = runFactor * 2.5;
                pos.x += sin(t + phase) * legPower;
                pos.y += max(0.0, cos(t + phase)) * legPower * 0.8;
            } else { // Ë∫´
                pos.y += sin(t * 2.0) * 0.2 * runFactor;
            }
            // Èº†Ê†á‰∫§‰∫í
            float d = distance(pos.xy, mousePos.xy * 40.0);
            if (d < 15.0) {
                vec3 dir = normalize(pos - vec3(mousePos.xy * 40.0, 0.0));
                pos += dir * (15.0 - d) * 0.3;
            }
            // Êï£ÂºÄ
            if (scatter > 0.0) {
                pos.x += sin(pos.y * 10.0 + time) * scatter * 10.0;
                vAlpha = 1.0 - scatter * 0.8;
            }
            vec4 mvPosition = modelViewMatrix * vec4(pos, 1.0);
            gl_PointSize = size * (300.0 / -mvPosition.z);
            gl_Position = projectionMatrix * mvPosition;
        }
    </script>
    <script type="x-shader/x-fragment" id="fragmentshader">
        varying vec3 vColor; varying float vAlpha;
        void main() {
            vec2 cxy = 2.0 * gl_PointCoord - 1.0;
            if (dot(cxy, cxy) > 1.0) discard;
            gl_FragColor = vec4(vColor, vAlpha * 0.8);
        }
    </script>

    <script>
        function log(msg) { document.getElementById('debug-log').innerText = msg; console.log(msg); }

        const CONFIG = { particleSize: 0.8, colors: { red: new THREE.Color(0xdd2222), gold: new THREE.Color(0xffd700), black: new THREE.Color(0x220000) } };
        let scene, camera, renderer, particles, uniforms;
        let mouse = new THREE.Vector2(-999, -999);
        const STATE = { mode: 'HORSE' }; 

        // --- 1. ÂêØÂä®ÈÄªËæë (Â§çÂàª V3.4) ---
        window.onload = function() {
            const btn = document.getElementById('start-btn');
            const txt = document.getElementById('loading-text');

            if (typeof THREE === 'undefined') {
                txt.innerText = "‚ùå Ê†∏ÂøÉÂ∫ìÂä†ËΩΩÂ§±Ë¥• (ËØ∑Âà∑Êñ∞)";
                log("Error: Three.js missing");
                return;
            }

            txt.style.display = 'none';
            btn.style.display = 'block'; // ÊòæÁ§∫ÊåâÈíÆ

            btn.onclick = () => {
                document.getElementById('loader').style.opacity = 0;
                setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
                
                try {
                    init();
                    startAI();
                } catch(e) {
                    alert("ËøêË°åÈîôËØØ: " + e.message);
                }
            };
        };

        // --- 2. ÁªòÂà∂È©¨Ââ™ÂΩ± (Artist) ---
        function drawHorseSilhouette() {
            const canvas = document.createElement('canvas');
            const size = 256; canvas.width = size; canvas.height = size;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#000000'; ctx.fillRect(0, 0, size, size);
            ctx.fillStyle = '#ffffff'; ctx.beginPath();
            const ox = 100, oy = 130; const s = 0.6;
            ctx.moveTo(ox + 50*s, oy - 100*s); ctx.lineTo(ox + 80*s, oy - 90*s);
            ctx.quadraticCurveTo(ox + 60*s, oy - 60*s, ox + 40*s, oy - 50*s);
            ctx.quadraticCurveTo(ox + 60*s, oy + 20*s, ox + 80*s, oy + 50*s);
            ctx.lineTo(ox + 70*s, oy + 100*s); ctx.lineTo(ox + 50*s, oy + 60*s);
            ctx.lineTo(ox - 50*s, oy + 40*s); ctx.lineTo(ox - 80*s, oy + 90*s); ctx.lineTo(ox - 100*s, oy + 50*s);
            ctx.quadraticCurveTo(ox - 120*s, oy, ox - 50*s, oy - 40*s);
            ctx.quadraticCurveTo(ox, oy - 60*s, ox + 30*s, oy - 110*s); ctx.fill();
            ctx.fillStyle = '#808080'; ctx.beginPath(); 
            ctx.ellipse(ox + 20*s, oy - 90*s, 30*s, 10*s, -0.5, 0, 6.28); ctx.fill();
            ctx.beginPath(); 
            ctx.moveTo(ox - 110*s, oy); ctx.quadraticCurveTo(ox - 150*s, oy + 50*s, ox - 130*s, oy + 80*s);
            ctx.lineTo(ox - 110*s, oy + 30*s); ctx.fill();
            return { canvas, ctx };
        }

        function init() {
            const container = document.getElementById('canvas-container');
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 60; camera.position.y = 5;
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            container.appendChild(renderer.domElement);
            createParticles();
            document.addEventListener('mousemove', onMouseMove, false);
            window.addEventListener('resize', onResize, false);
            animate();
        }

        function createParticles() {
            const { canvas, ctx } = drawHorseSilhouette();
            const w = canvas.width; const h = canvas.height;
            const data = ctx.getImageData(0, 0, w, h).data;
            const positions=[], colors=[], sizes=[], limbTypes=[];
            for(let y=0; y<h; y+=2) {
                for(let x=0; x<w; x+=2) {
                    const i = (y*w + x)*4; const r = data[i];
                    if(data[i+3] > 20) {
                        const px = (x - w/2) * 0.25; const py = -(y - h/2) * 0.25; const pz = (Math.random()-0.5) * 3.0;
                        positions.push(px, py, pz);
                        const c = new THREE.Color();
                        if (r > 200) c.copy(CONFIG.colors.red).lerp(CONFIG.colors.black, Math.random()*0.5);
                        else c.copy(CONFIG.colors.gold);
                        colors.push(c.r, c.g, c.b);
                        sizes.push(CONFIG.particleSize * (0.8 + Math.random()));
                        let type = 0.0; if (r > 100 && r < 200) type = 1.0; if (py < -5) type = 2.0; 
                        limbTypes.push(type);
                    }
                }
            }
            const geo = new THREE.BufferGeometry();
            geo.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geo.setAttribute('customColor', new THREE.Float32BufferAttribute(colors, 3));
            geo.setAttribute('size', new THREE.Float32BufferAttribute(sizes, 1));
            geo.setAttribute('limbType', new THREE.Float32BufferAttribute(limbTypes, 1));
            uniforms = { time: { value: 0.0 }, runFactor: { value: 0.0 }, scatter: { value: 0.0 }, mousePos: { value: new THREE.Vector3(0,0,0) } };
            const mat = new THREE.ShaderMaterial({ uniforms: uniforms, vertexShader: document.getElementById('vertexshader').textContent, fragmentShader: document.getElementById('fragmentshader').textContent, blending: THREE.AdditiveBlending, depthTest: false, transparent: true });
            particles = new THREE.Points(geo, mat);
            scene.add(particles);
            particles.position.x = -5;
        }

        function onMouseMove(e) { e.preventDefault(); mouse.x = (e.clientX / window.innerWidth) * 2 - 1; mouse.y = -(e.clientY / window.innerHeight) * 2 + 1; if(uniforms) uniforms.mousePos.value.set(mouse.x, mouse.y, 0); }
        function onResize() { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); }
        function animate() { requestAnimationFrame(animate); if(uniforms) { uniforms.time.value += 0.05; let tr = (STATE.mode === 'RUNNING') ? 1.0 : 0.0; let ts = (STATE.mode === 'SCATTER') ? 1.0 : 0.0; uniforms.runFactor.value += (tr - uniforms.runFactor.value) * 0.05; uniforms.scatter.value += (ts - uniforms.scatter.value) * 0.05; particles.rotation.y = Math.sin(uniforms.time.value * 0.1) * 0.15; } renderer.render(scene, camera); }

        async function startAI() {
            const video = document.getElementsByClassName('input_video')[0];
            const stat = document.getElementById('gesture-status');
            if(typeof Hands === 'undefined') { stat.innerText = "‰ªÖÈº†Ê†áÊ®°Âºè"; return; }
            const hands = new Hands({locateFile: (file) => `https://unpkg.com/@mediapipe/hands/${file}`});
            hands.setOptions({ maxNumHands: 1, minDetectionConfidence: 0.7, minTrackingConfidence: 0.7 });
            hands.onResults(res => {
                if(res.multiHandLandmarks && res.multiHandLandmarks.length > 0) {
                    const lm = res.multiHandLandmarks[0];
                    if (lm[8].y < lm[6].y && lm[12].y < lm[10].y && lm[16].y > lm[14].y) { STATE.mode = 'RUNNING'; stat.innerText = "‚úåÔ∏è Â•îË∑ë (Gallop)"; } 
                    else if (Math.hypot(lm[8].x-lm[4].x, lm[8].y-lm[4].y) < 0.05) { stat.innerText = "üëå ÊäìÂèñ (Grab)"; } 
                    else if (lm[8].y > lm[5].y) { STATE.mode = 'HORSE'; stat.innerText = "‚úä ÂÅúÊ≠¢ (Stop)"; } 
                    else { STATE.mode = 'SCATTER'; stat.innerText = "üñê Êï£ÂºÄ (Scatter)"; }
                } else { stat.innerText = "Á≠âÂæÖÊåá‰ª§..."; STATE.mode = 'HORSE'; }
            });
            const cam = new Camera(video, { onFrame: async () => { await hands.send({image: video}); }, width: 480, height: 360 });
            await cam.start(); stat.innerText = "AI ÊøÄÊ¥ª";
        }
    </script>
</body>
</html>
